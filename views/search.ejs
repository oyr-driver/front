<!DOCTYPE html>
<html>
<head>
    <title>Search</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Batang&family=Nanum+Gothic:wght@800&display=swap" rel="stylesheet">
    <style>
        *{font-family: 'Gowun Batang', serif 'Nanum Gothic', sans-serif;}
        .group{margin-top:300px;}
        .here{font-size:60px; margin-left:40px;}
        .enter{font-size:50px;}
        #addr{height:70px; width:530px; border-radius: 10px; font-size:20px;}
        .button_group{text-align:center;}
        .box{ width:auto; height:auto; font-size:45px; background:white; border-radius: 15px;margin:0px 5px;padding:0px 5px; font-weight:bold;}
    </style>
</head>
<body>
    <div id="pass" style="display:none;"><%=id%></div>
    <div class="group">
        <div class="here">
            <img src="https://e7.pngegg.com/pngimages/199/694/png-clipart-computer-icons-map-location-sign-cdr-black-thumbnail.png" 
            style="width:50px; height:50px">
            <span class="change1" >위치를 작성해주세요.</span>
            <span class="change2" style="display:none;">작성하신 위치가 맞습니까?</span>
        </div>
        <br><br>
        <div class="enter" style="position:relative;">
            &nbsp;&nbsp;&nbsp;주소입력
            <input type="text" id="addr" placeholder="서울특별시..." style="font-size:40px;">
            <button class="search box" style="position:relative; top:5px;">확인</button>
        </div>

        <br>
        <div id="map" style="width:90%; height:800px; margin:auto;"></div>

        <br>
        <div class="button_group">
            <button class="box" onclick="movingL();">
                이전페이지
            </button>
            <button class="again box" onclick="movingSearch();" style="display:none;">다시 입력하기</button>
            <button class="done box" onclick="moving(); movingDone();" style="display:none;"><!--id!!!!!!!!!!!!!!!!!!!!!!-->
                위치 선택 완료
            </button>
        </div>
    </div>

    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=ceb1e710105acfa93e70fad67dd086ef&libraries=services"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script> <!--admin서버로 정보 전달 위함-->
    <script>
        var lat, lon, loc;

        var mapContainer = document.getElementById('map'), // 지도를 표시할 div 
        mapOption = {
            center: new kakao.maps.LatLng(33.450701, 126.570667),// 지도의 중심좌표
            level: 1 // 지도의 확대 레벨
        };  

        // 지도를 생성합니다  
        var map = new kakao.maps.Map(mapContainer, mapOption);

        // 주소-좌표 변환 객체를 생성합니다
        var geocoder = new kakao.maps.services.Geocoder();

        const search=document.querySelector('.search');

        search.onclick=function(){
            const address=document.getElementById('addr').value;//입력한 주소

            // 주소로 좌표를 검색합니다
            geocoder.addressSearch(address, function(result, status) {

                // 정상적으로 검색이 완료됐으면 
                if (status === kakao.maps.services.Status.OK) {
                    var change1=document.querySelector('.change1');//위치를 입력해주세요 에서 맞습니까 로 바꾸기
                    change1.style.display='none';
                    var change2=document.querySelector('.change2');//위치를 입력해주세요 에서 맞습니까 로 바꾸기
                    change2.style.display='inline';

                    var write = document.getElementById('addr').disabled=true;//주소입력창 비활성화

                    var find=document.querySelector('.search');//주소 입력 완료 버튼 안보이게
                    find.style.display="none";

                    var again=document.querySelector('.again');//다시 입력하기 버튼 보이게
                    again.style.display="inline";

                    var coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                    lat=coords.Ma;
                    lon=coords.La;
                    // 결과값으로 받은 위치를 마커로 표시합니다
                    var marker = new kakao.maps.Marker({
                        map: map,
                        position: coords
                    });

                    // 인포윈도우로 장소에 대한 설명을 표시합니다
                    var infowindow = new kakao.maps.InfoWindow({
                        content: '<div style="width:700px;text-align:center;padding:6px 0;font-size:40px;">'+address+'</div>'
                    });
                    infowindow.open(map, marker);
                    loc=address;

                    // 지도의 중심을 결과값으로 받은 위치로 이동시킵니다
                    map.setCenter(coords);

                    var btn2=document.querySelector('.done');
                    btn2.style.display="inline";
                } 
                else{
                    alert('다시 입력해주세요');
                }
            });    
        }

        function moving(){
            var send={
                "lat":lat,
                "lon":lon,
                "loc":loc
            };
            localStorage.setItem("send",JSON.stringify(send));//localStorage에 저장해서 다른 파일에서도 사용할 수 있도록
        }

        var pass=document.getElementById('pass');
        var id=pass.innerHTML;//값 가져오기
        
        function movingL(){
            location.href=`/l/${id}`;
        }

        function movingSearch(){
            location.href=`/search/${id}`;
        }

        async function movingDone(){
            /*admin 서버로 정보 전달 위함*/
            try {
                await axios.post(`https://admin.goodde.net/api/calls/${id}/location/submit`, {//정보 전달할 페이지
                    lat: lat,
                    lon: lon,
                    addr: loc
                });
            }
            catch(err) {
                alert(`오류가 발생했습니다.\n${err.message}`);
                return;
            }

            location.href=`/done/${id}`;
        }
    </script>
</body>
</html>